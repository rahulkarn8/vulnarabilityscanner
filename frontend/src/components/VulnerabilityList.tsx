import { useState, useEffect } from 'react'
import { AlertTriangle, CheckCircle2, Lightbulb, Brain } from 'lucide-react'
import { Vulnerability } from '../App'
import './VulnerabilityList.css'

interface VulnerabilityListProps {
  vulnerabilities: Vulnerability[]
  selectedVulnerability: Vulnerability | null
  onVulnerabilitySelect: (vuln: Vulnerability) => void
}

function VulnerabilityList({
  vulnerabilities,
  selectedVulnerability,
  onVulnerabilitySelect
}: VulnerabilityListProps) {
  const [showAIAttacksOnly, setShowAIAttacksOnly] = useState(false)
  
  // Count AI attack vulnerabilities in current file
  const aiAttackCount = vulnerabilities.filter(vuln => vuln.scanner === 'ai_attack').length
  
  // Reset filter when switching to a file with no AI attacks (if filter is active)
  useEffect(() => {
    if (showAIAttacksOnly && aiAttackCount === 0) {
      // If filter is active but current file has no AI attacks, reset the filter
      setShowAIAttacksOnly(false)
    }
  }, [vulnerabilities, showAIAttacksOnly, aiAttackCount])
  
  // Filter vulnerabilities based on AI attack filter
  const filteredVulnerabilities = showAIAttacksOnly
    ? vulnerabilities.filter(vuln => vuln.scanner === 'ai_attack')
    : vulnerabilities
  const getSeverityColor = (severity: string) => {
    switch (severity.toLowerCase()) {
      case 'critical':
        return '#dc2626'
      case 'high':
        return '#ea580c'
      case 'medium':
        return '#f59e0b'
      case 'low':
        return '#3b82f6'
      default:
        return '#64748b'
    }
  }

  const getSeverityIcon = (severity: string) => {
    return <AlertTriangle size={16} />
  }

  if (vulnerabilities.length === 0) {
    return (
      <div className="vulnerability-list">
        <div className="vulnerability-list-header">
          <h3>Vulnerabilities</h3>
        </div>
        <div className="vulnerability-list-empty">
          <div className="safe-icon">
            <CheckCircle2 size={40} />
          </div>
          <p>No vulnerabilities found</p>
        </div>
      </div>
    )
  }

  return (
    <div className="vulnerability-list">
      <div className="vulnerability-list-header">
        <div className="vulnerability-header-content">
          <h3>
            Vulnerabilities ({filteredVulnerabilities.length}
            {showAIAttacksOnly && ` of ${vulnerabilities.length}`})
          </h3>
          <div className="ai-attack-filter">
            <button
              className={`filter-toggle ${showAIAttacksOnly ? 'active' : ''} ${aiAttackCount === 0 && !showAIAttacksOnly ? 'disabled' : ''}`}
              onClick={() => {
                // Allow toggling off even if current file has no AI attacks
                // This allows users to see normal vulnerabilities after filtering
                if (showAIAttacksOnly || aiAttackCount > 0) {
                  setShowAIAttacksOnly(!showAIAttacksOnly)
                }
              }}
              disabled={aiAttackCount === 0 && !showAIAttacksOnly}
              title={
                aiAttackCount === 0 && !showAIAttacksOnly
                  ? 'No AI attack vulnerabilities found in this file' 
                  : showAIAttacksOnly 
                    ? 'Click to show all vulnerabilities' 
                    : 'Click to show only AI attack vulnerabilities'
              }
            >
              <Brain size={16} />
              <span>
                {showAIAttacksOnly 
                  ? 'Show All' 
                  : aiAttackCount > 0 
                    ? `AI Attacks (${aiAttackCount})` 
                    : 'AI Attacks (0)'}
              </span>
            </button>
          </div>
        </div>
      </div>
      {showAIAttacksOnly && filteredVulnerabilities.length === 0 && (
        <div className="vulnerability-list-empty">
          <div className="safe-icon">
            <CheckCircle2 size={40} />
          </div>
          <p>No AI attack vulnerabilities found</p>
        </div>
      )}
      {filteredVulnerabilities.length > 0 && (
        <div className="vulnerability-list-content">
          {filteredVulnerabilities.map((vuln, index) => (
          <div
            key={index}
            className={`vulnerability-item ${selectedVulnerability === vuln ? 'selected' : ''}`}
            onClick={() => onVulnerabilitySelect(vuln)}
          >
            <div className="vulnerability-item-header">
              <div className="vulnerability-severity">
                <span
                  className="severity-badge"
                  style={{ backgroundColor: getSeverityColor(vuln.severity) }}
                >
                  {vuln.severity.toUpperCase()}
                </span>
                <span className="vulnerability-line">Line {vuln.line_number}</span>
              </div>
            </div>
            <div className="vulnerability-type">
              {getSeverityIcon(vuln.severity)}
              <span>{vuln.vulnerability_type}</span>
              {vuln.scanner === 'ai_attack' && (
                <span className="ai-attack-badge" title="AI Attack Vulnerability">
                  <Brain size={14} />
                  <span>AI Attack</span>
                </span>
              )}
            </div>
            <div className="vulnerability-description">
              {vuln.description}
            </div>
            {vuln.suggested_fix && (
              <div className="vulnerability-fix">
                <div className="fix-header">
                  <Lightbulb size={14} />
                  <span>Suggested Fix</span>
                </div>
                <pre className="fix-code">{vuln.suggested_fix}</pre>
              </div>
            )}
          </div>
          ))}
        </div>
      )}
    </div>
  )
}

export default VulnerabilityList

